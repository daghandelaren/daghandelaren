// Prisma schema for Daghandelaren

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  role         String   @default("USER") // "USER" or "ADMIN"
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// Data source configuration
model SentimentSource {
  id        String   @id @default(cuid())
  name      String   @unique // "myfxbook", "oanda", "dukascopy"
  baseUrl   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  snapshots SentimentSnapshot[]
}

// Trading instrument (forex pair, commodity, index)
model Instrument {
  id         String   @id @default(cuid())
  symbol     String   @unique // "EUR/USD", "XAU/USD"
  base       String // "EUR", "XAU"
  quote      String // "USD"
  assetClass String // "forex", "commodity", "index"
  createdAt  DateTime @default(now())

  snapshots SentimentSnapshot[]
}

// Scraper run logs (auto-cleaned after 12 hours)
model ScraperLog {
  id              String   @id @default(cuid())
  timestamp       DateTime @default(now())
  totalScrapers   Int
  successCount    Int
  failedCount     Int
  instrumentCount Int
  failedScrapers  String[] // Names of failed scrapers
  errorMessages   String[] // Error messages from failed scrapers
  deletedSnapshots Int     @default(0)

  @@index([timestamp])
}

// Access requests from login page
model AccessRequest {
  id        String   @id @default(cuid())
  name      String
  email     String
  reason    String
  status    String   @default("PENDING") // "PENDING", "APPROVED", "REJECTED"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}

// Sentiment data snapshot
model SentimentSnapshot {
  id           String   @id @default(cuid())
  instrumentId String
  sourceId     String
  longPercent  Float // % of traders long
  shortPercent Float // % of traders short
  netSentiment Float // longPercent - shortPercent
  timestamp    DateTime @default(now())

  instrument Instrument      @relation(fields: [instrumentId], references: [id])
  source     SentimentSource @relation(fields: [sourceId], references: [id])

  @@index([instrumentId, sourceId, timestamp])
  @@index([timestamp])
}

// ============================================
// FUNDAMENTAL ANALYSIS MODELS
// ============================================

// Currency fundamental data (AUD, CAD, CHF, EUR, GBP, JPY, NZD, USD)
model FundamentalCurrency {
  id                String   @id @default(cuid())
  currency          String   @unique // AUD, CAD, CHF, EUR, GBP, JPY, NZD, USD

  // Indicators (each maps to +1/0/-1)
  inflationTrend    String   @default("Flat")    // Rising/Flat/Falling
  pmiSignal         String   @default("Flat")    // Positive/Flat/Negative
  centralBankTone   String   @default("Neutral") // Hawkish/Neutral/Dovish
  rateDifferential  String   @default("Flat")    // Positive/Flat/Negative
  commodityTailwind String   @default("Neutral") // Yes/Neutral/No
  // Note: Risk sentiment is GLOBAL (Risk-on/Risk-off/Neutral) stored in FundamentalSettings.riskRegime

  // Calculated scores
  baseScore         Int      @default(0)
  commodityAdj      Int      @default(0)
  riskAdj           Int      @default(0)
  totalScore        Int      @default(0)
  rating            String   @default("Neutral") // Bullish/Neutral/Bearish

  // Economic data actual values
  cpiActual         Float?   // Current CPI value (e.g., 3.2)
  cpiPrevious       Float?   // Previous CPI value (e.g., 2.9)
  pmiActual         Float?   // Current PMI value (e.g., 52.4)
  pmiPrevious       Float?   // Previous PMI value (e.g., 51.8)

  // Yield and market data
  yield2Y           Float?   // Current 2Y yield
  yieldDiffVsUsd    Float?   // Yield differential vs USD
  yieldDiffMa20     Float?   // 20-day MA of yield differential
  yieldDiffMa60     Float?   // 60-day MA of yield differential

  // Commodity basket value (for AUD, CAD, NZD)
  commodityBasket   Float?   // Current commodity basket value
  commodityMa90     Float?   // 90-day MA of commodity basket

  // AI metadata
  aiJustification   String?  @db.Text // AI's reasoning
  manualOverride    Boolean  @default(false)
  lastUpdated       DateTime @default(now())
  updatedBy         String?  // "AI" or admin email

  @@index([currency])
}

// Global fundamental settings
model FundamentalSettings {
  id                         String   @id @default(cuid())
  bullishThreshold           Int      @default(3)  // Score >= this = Bullish
  bearishThreshold           Int      @default(-3) // Score <= this = Bearish
  riskRegime                 String   @default("Neutral") // Risk-on/Neutral/Risk-off
  riskSentimentJustification String?  @db.Text // AI's reasoning for risk sentiment

  // VIX-based risk calculation
  vixCurrent                 Float?   // Current VIX value
  vixMa90                    Float?   // 90-day MA of VIX
  vixTrending                String?  // "rising", "falling", "flat"

  lastUpdated                DateTime @default(now())
}

// Historical snapshots for tracking changes
model FundamentalHistory {
  id        String   @id @default(cuid())
  currency  String
  snapshot  Json     // Full currency data at that point
  source    String   // "AI" or admin email
  createdAt DateTime @default(now())

  @@index([currency, createdAt])
}

// AI chat messages for macro Q&A
model AIChatMessage {
  id        String   @id @default(cuid())
  userId    String
  role      String   // "user" or "assistant"
  content   String   @db.Text
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

// ============================================
// MARKET DATA TIME SERIES (for rule-based scoring)
// ============================================

// 2-Year bond yields for yield differential calculations
model YieldData {
  id        String   @id @default(cuid())
  currency  String   // USD, EUR, GBP, JPY, CHF, AUD, NZD, CAD
  yield2Y   Float    // 2-year government bond yield (%)
  date      DateTime @db.Date
  createdAt DateTime @default(now())

  @@unique([currency, date])
  @@index([currency])
  @@index([date])
}

// VIX data for risk sentiment calculation
model VixData {
  id        String   @id @default(cuid())
  value     Float    // VIX close value
  date      DateTime @unique @db.Date
  createdAt DateTime @default(now())

  @@index([date])
}

// Commodity prices for commodity tailwind calculations
model CommodityData {
  id        String   @id @default(cuid())
  commodity String   // IRON_ORE, COPPER, OIL_WTI, DAIRY
  price     Float    // Price in USD
  date      DateTime @db.Date
  createdAt DateTime @default(now())

  @@unique([commodity, date])
  @@index([commodity])
  @@index([date])
}

